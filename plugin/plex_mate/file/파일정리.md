

### 배경지식
----
  * Plex는 여러 Agent가 메타 생성에 기여할 수 있음

  * 그게 메타 우선순위이며 LocalMedia가 메인 에이전트보다 높은 순위에 있는 경우    
    영상 파일내의 Tag에 있는 제목이 우선순위에 따라 먼저 선택됨. (흔한 제목이 이상해요 하는 질문)

  * 포스터, 아트 등도 마찬가지로 여러 에이전트들이 썸네일 혹은 원본을 파일로 저장함.

  * 메타별 _comined 폴더가 있고 이 폴더는 각 에이전트 우선순위에 따른 최종 결과값(xml) 및 이미지 파일 링크

  * 메타별 _stored 폴더가 있고 이미 받은 파일을 다시 받거나, 포스터 선택시 저장됨.

  * _combined 폴더는 A, B 에이전트나 _stored 폴더로의 링크임   
    윈도우는 링크가 아닌 동일 파일을 복사하여 가지고 있으므로 무조건 하나의 이미지가 2~3개씩 있음
  
  * ** 1단계 - 사용하지 않는 이미지 파일을 삭제 **   
    A, B 에이전트에서 포스터 5개씩 제공한다면 해당 이미지에 대한 썸네일(지원시) 혹은 원본을 파일로 저장해 놓고 있고 
    사용자가 포스터 선택할 때 보여줌.   
    이 파일들을 지운다 하더라도 메타새로고침하면 다시 가져오기 때문에 보관할 필요가 없음.   
    1단계는 이런 현재 사용하지 않는 이미지 파일을 찾아서 지움   
    약 50% 이상 용량 감소

  * 이런 메타이미지, 메타가 없는 경우 미디어 이미지는 db에 아래 정보로 저장됨   
    user_thumb_url : 포스터, 에피소드 썸네일   
    user_art_url : 배경   
    user_banner_url : 배너   
    user_music_url : 테마음악   
  
  * 저장 스키마는 보통 아래형식임.   
    미디어 이용(분석시 생성된 썸네일) : media://8/a326fbf09a1354a7740e0d8d0555050eeaad338.bundle/Contents/Thumbnails/thumb1.jpg   
    메타이용 : metadata://seasons/1/episodes/1/thumbs/com.plexapp.agents.sjva_agent_9e2ec577efcf231ce5ce1ba198b89bcd49d1fc87
  
  * 에이전트로는 metadata:// 스키마밖에 사용할 수 없지만 DB 직접 조작을 통해 이미지 주소를 넣으면 로컬 이미지를 사용하지 않고 http로 바로 이미지를 사용가능함.
  
  * Plex 유저폴더 / Cache / PhotoTranscoder 폴더가 있음.   
    이 폴더가 Plex 용량 증가의 주 원인이며 따로 지워주지 않는다면 계속 용량이 증가함.   
    모두 지워도 되며 캐시가 없다면 어짜피 다시 만듬

  * metadata:// 사용 - 로컬에 있는 이미지 파일 사용   
    http:// 사용 - 메타제공사이트에 있는 이미지 파일 사용   
    위 두 방식 모두 어짜피 PhotoTranscoder 에 캐시를 만들어 사용함.   
    로컬에 있는 파일로 만드냐 메타사이트에 있는 파일로 만드냐의 차이이며 약간의 속도차이는 나나 유의미하지 않음.

  * ** 2단계 **   
    선택된 파일(현 포스터, 아트 등)에 대한 메타사이트 측 URL이 있다면 이미지 파일을 지우고 DB에 http 값을 넣어줌.   
    메타데이터 폴더에는 xml 파일만 남게 되어 보통 1G를 넘지 않음   
    99% 용량 감소

  * Plex는 미디어 파일 분석시 모든 파일에 대한 썸네일을 생성.   
    예전 TV 프로그램 같이 에피소드별 썸네일 메타가 없는 경우 이런 파일들을 사용함.

  * ** 3단계 **   
    http 사용이 확정된 경우 media 분석시 생성한 썸네일 이미지도 삭제함.   
    분석시 생성한 파일의 크기가 원래 작기 때문에 그렇게 큰 용량 차이는 나지 않음

  
  * 반드시 DB 백업 후 사용

  * 충분히 테스트 한 후 적용   
    config.yaml 에서 쿼리 WHERE 조건을 추가하여 테스트
  
  * 간혹 썸네일이 안 보이는 경우가 있음.   
    보통 메타 구축 상태가 도중에 중단되는 경우로 보임   
    다시 메타새로고침 후 파일정리 이용
  
  * 지운 메타는 새로고침 할때마다 다시 다운로드 받아 저장함..   
    따라서 빈번하게 업데이트 되는 방송중 섹션 같은 곳은 적용할 필요 없음. (테스트 용이)


  
